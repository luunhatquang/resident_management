{% extends 'base.html' %}
{% load static %}

{% block title %}Qu·∫£n l√Ω H√≥a ƒë∆°n{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/invoices.css' %}">
{% endblock %}

{% block header_icon %}<i class="fa-solid fa-file-invoice-dollar"></i>{% endblock %}
{% block header_title %}Qu·∫£n l√Ω H√≥a ƒë∆°n{% endblock %}

{% block content %}
<!-- Revenue Stats -->
<div class="section-title" style="margin-bottom: 15px; margin-top: 0;">
    <h3 style="font-size: 18px; color: var(--text-main); display: flex; align-items: center; gap: 10px;">
        <i class="fa-solid fa-chart-line" style="color: var(--primary-color);"></i>
        Th·ªëng k√™ doanh thu
    </h3>
</div>
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-title">Doanh thu th√°ng n√†y</div>
        <div class="stat-value" style="color: var(--primary-color);">{{ revenue_this_month|floatformat:0|default:"0" }} VNƒê</div>
        <div style="color: {% if compare_revenue >= 0 %}#10b981{% else %}#ef4444{% endif %}; font-size: 12px; margin-top: 5px;">
            <i class="fa-solid {% if compare_revenue >= 0 %}fa-arrow-trend-up{% else %}fa-arrow-trend-down{% endif %}"></i> 
            {{ compare_revenue|floatformat:1 }}% so v·ªõi th√°ng tr∆∞·ªõc
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-title">Doanh thu nƒÉm nay</div>
        <div class="stat-value" style="color: var(--status-empty);">{{ revenue_this_year|floatformat:0|default:"0" }} VNƒê</div>
        <div style="color: {% if compare_revenue_year >= 0 %}#10b981{% else %}#ef4444{% endif %}; font-size: 12px; margin-top: 5px;">
            <i class="fa-solid {% if compare_revenue_year >= 0 %}fa-arrow-trend-up{% else %}fa-arrow-trend-down{% endif %}"></i> 
            {{ compare_revenue_year|floatformat:1 }}% so v·ªõi nƒÉm tr∆∞·ªõc
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-title">T·ªïng doanh thu</div>
        <div class="stat-value">{{ revenue|floatformat:0|default:"0" }} VNƒê</div>
    </div>
</div>

<!-- Invoice Stats -->
<div class="section-title" style="margin-bottom: 15px; margin-top: 30px;">
    <h3 style="font-size: 18px; color: var(--text-main); display: flex; align-items: center; gap: 10px;">
        <i class="fa-solid fa-file-invoice" style="color: var(--primary-color);"></i>
        Th·ªëng k√™ h√≥a ƒë∆°n
    </h3>
</div>
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-title">T·ªïng h√≥a ƒë∆°n</div>
        <div class="stat-value">{{ invoice_total|default:"0" }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-title">ƒê√£ thanh to√°n</div>
        <div class="stat-value" style="color: var(--status-empty);">{{ invoice_paid|default:"0" }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-title">Ch∆∞a thanh to√°n</div>
        <div class="stat-value" style="color: var(--status-maintenance);">{{ invoice_unpaid|default:"0" }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-title">Qu√° h·∫°n</div>
        <div class="stat-value" style="color: var(--status-occupied);">{{ invoice_overdue|default:"0" }}</div>
    </div>
</div>

<!-- Filters & Actions -->
<div class="section-header">
    <div class="filters">
        <select id="filter-status" class="filter-select" onchange="applyFilters()">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="paid">ƒê√£ thanh to√°n</option>
            <option value="unpaid">Ch∆∞a thanh to√°n</option>
            <option value="overdue">Qu√° h·∫°n</option>
        </select>
        
        <select id="filter-service" class="filter-select" onchange="applyFilters()">
            <option value="">T·∫•t c·∫£ lo·∫°i d·ªãch v·ª•</option>
            <option value="rent">Ti·ªÅn thu√™ ph√≤ng</option>
            <option value="electricity">ƒêi·ªán</option>
            <option value="water">N∆∞·ªõc</option>
            <option value="internet">Internet</option>
            <option value="maintenance">B·∫£o tr√¨</option>
            <option value="other">Kh√°c</option>
        </select>
        
        <input type="text" id="search-input" class="search-input" 
               placeholder="üîç T√¨m m√£ h√≥a ƒë∆°n, ph√≤ng..." 
               onkeypress="if(event.key==='Enter') applyFilters()">
        
        <button class="btn-secondary" onclick="applyFilters()" style="padding: 10px 16px;">
            <i class="fa-solid fa-search"></i>
        </button>
        
        {% if search_keyword or filter_status or filter_service %}
        <button class="btn-secondary" onclick="clearFilters()" style="padding: 10px 16px;" title="X√≥a b·ªô l·ªçc">
            <i class="fa-solid fa-times"></i>
        </button>
        {% endif %}
    </div>
    
    <button class="btn-primary" onclick="openAddModal()">
        <i class="fa-solid fa-plus"></i> Th√™m h√≥a ƒë∆°n
    </button>
</div>

<!-- Invoices Table -->
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>M√£ Hƒê</th>
                <th>Lo·∫°i d·ªãch v·ª•</th>
                <th>Ph√≤ng</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>ƒê∆°n gi√°</th>
                <th>T·ªïng ti·ªÅn</th>
                <th>Ng√†y thu ph√≠</th>
                <th>Ng√†y h·∫øt h·∫°n</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody id="invoices-tbody">
            {% if invoices %}
                {% for invoice in invoices %}
                <tr>
                    <td><strong>{{ invoice.invoice_id }}</strong></td>
                    <td>
                        {% if invoice.service == 'rent' %}
                            <span class="badge badge-primary">Ti·ªÅn thu√™</span>
                        {% elif invoice.service == 'electricity' %}
                            <span class="badge badge-warning">ƒêi·ªán</span>
                        {% elif invoice.service == 'water' %}
                            <span class="badge badge-info">N∆∞·ªõc</span>
                        {% elif invoice.service == 'internet' %}
                            <span class="badge badge-success">Internet</span>
                        {% elif invoice.service == 'maintenance' %}
                            <span class="badge badge-danger">B·∫£o tr√¨</span>
                        {% else %}
                            <span class="badge">Kh√°c</span>
                        {% endif %}
                    </td>
                    <td>
                        <div>{{ invoice.room.building.name }}</div>
                        <div style="font-size: 0.85em; color: #64748b;">{{ invoice.room.room_number }}</div>
                    </td>
                    <td>{{ invoice.count_unit }}</td>
                    <td>{{ invoice.unit_price|floatformat:0 }} VNƒê</td>
                    <td><strong style="color: var(--primary-color);">{{ invoice.total_price|floatformat:0 }} VNƒê</strong></td>
                    <td>{{ invoice.start_date|date:"d/m/Y" }}</td>
                    <td>
                        {% if invoice.end_date %}
                            {{ invoice.end_date|date:"d/m/Y" }}
                        {% else %}
                            <span style="color: #999;">--</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if invoice.status == 'paid' %}
                            <span class="status-badge status-paid">ƒê√£ thanh to√°n</span>
                        {% elif invoice.status == 'unpaid' %}
                            <span class="status-badge status-unpaid">Ch∆∞a thanh to√°n</span>
                        {% elif invoice.status == 'overdue' %}
                            <span class="status-badge status-overdue">Qu√° h·∫°n</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon" onclick="viewInvoice('{{ invoice.invoice_id }}')" title="Xem chi ti·∫øt">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                            <button class="btn-icon" onclick="editInvoice('{{ invoice.invoice_id }}')" title="Ch·ªânh s·ª≠a">
                                <i class="fa-solid fa-edit"></i>
                            </button>
                            {% if invoice.status != 'paid' %}
                            <button class="btn-icon btn-success" onclick="markAsPaid('{{ invoice.invoice_id }}')" title="ƒê√°nh d·∫•u ƒë√£ thanh to√°n">
                                <i class="fa-solid fa-check"></i>
                            </button>
                            {% endif %}
                            <button class="btn-icon btn-danger" onclick="deleteInvoice('{{ invoice.invoice_id }}')" title="X√≥a">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="10" style="text-align: center; padding: 40px; color: #999;">
                        <i class="fa-solid fa-inbox"></i><br>
                        {% if search_keyword %}
                            Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n v·ªõi t·ª´ kh√≥a "{{ search_keyword }}"
                        {% else %}
                            Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o
                        {% endif %}
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/invoices.js' %}"></script>
{% endblock %}
