{% extends 'base.html' %}
{% load static %}

{% block title %}Qu·∫£n l√Ω H√≥a ƒë∆°n{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/invoices.css' %}">
{% endblock %}

{% block header_icon %}<i class="fa-solid fa-file-invoice-dollar"></i>{% endblock %}
{% block header_title %}Qu·∫£n l√Ω H√≥a ƒë∆°n{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Revenue Stats -->
    <div class="stats-grid">
        <div class="stat-card blue">
            <div class="stat-header">
                <div class="stat-content">
                    <div class="stat-title">Doanh thu th√°ng n√†y</div>
                    <div class="stat-value">{{ revenue_this_month|floatformat:0 }}</div>
                    <div class="stat-subtitle {% if compare_revenue >= 0 %}positive{% else %}negative{% endif %}">
                        <i class="fa-solid {% if compare_revenue >= 0 %}fa-arrow-trend-up{% else %}fa-arrow-trend-down{% endif %}"></i>
                        {{ compare_revenue|floatformat:1 }}% so v·ªõi th√°ng tr∆∞·ªõc
                    </div>
                </div>
                <div class="stat-icon blue">
                    <i class="fa-solid fa-calendar-check"></i>
                </div>
            </div>
        </div>
        
        <div class="stat-card green">
            <div class="stat-header">
                <div class="stat-content">
                    <div class="stat-title">Doanh thu nƒÉm nay</div>
                    <div class="stat-value">{{ revenue_this_year|floatformat:0 }}</div>
                    <div class="stat-subtitle {% if compare_revenue_year >= 0 %}positive{% else %}negative{% endif %}">
                        <i class="fa-solid {% if compare_revenue_year >= 0 %}fa-arrow-trend-up{% else %}fa-arrow-trend-down{% endif %}"></i>
                        {{ compare_revenue_year|floatformat:1 }}% so v·ªõi nƒÉm tr∆∞·ªõc
                    </div>
                </div>
                <div class="stat-icon green">
                    <i class="fa-solid fa-chart-line"></i>
                </div>
            </div>
        </div>
        
        <div class="stat-card purple">
            <div class="stat-header">
                <div class="stat-content">
                    <div class="stat-title">T·ªïng doanh thu</div>
                    <div class="stat-value">{{ revenue|floatformat:0 }}</div>
                    <div class="stat-subtitle">VNƒê</div>
                </div>
                <div class="stat-icon purple">
                    <i class="fa-solid fa-money-bill-wave"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Stats -->
    <div class="stats-grid">
        <div class="stat-card blue">
            <div class="stat-header">
                <div class="stat-content">
                    <div class="stat-title">T·ªïng h√≥a ƒë∆°n</div>
                    <div class="stat-value">{{ invoice_total }}</div>
                </div>
                <div class="stat-icon blue">
                    <i class="fa-solid fa-file-invoice"></i>
                </div>
            </div>
        </div>
        
        <div class="stat-card green">
            <div class="stat-header">
                <div class="stat-content">
                    <div class="stat-title">ƒê√£ thanh to√°n</div>
                    <div class="stat-value">{{ invoice_paid }}</div>
                </div>
                <div class="stat-icon green">
                    <i class="fa-solid fa-check-circle"></i>
                </div>
            </div>
        </div>
        
        <div class="stat-card orange">
            <div class="stat-header">
                <div class="stat-content">
                    <div class="stat-title">Ch∆∞a thanh to√°n</div>
                    <div class="stat-value">{{ invoice_unpaid }}</div>
                </div>
                <div class="stat-icon orange">
                    <i class="fa-solid fa-clock"></i>
                </div>
            </div>
        </div>
        
        <div class="stat-card red">
            <div class="stat-header">
                <div class="stat-content">
                    <div class="stat-title">Qu√° h·∫°n</div>
                    <div class="stat-value">{{ invoice_overdue }}</div>
                </div>
                <div class="stat-icon red">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters & Actions -->
    <div class="section-header">
        <div class="filters">
            <form method="GET" class="form-inline">
                <select name="status" class="filter-select">
                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="paid" {% if selected_status == 'paid' %}selected{% endif %}>ƒê√£ thanh to√°n</option>
                    <option value="unpaid" {% if selected_status == 'unpaid' %}selected{% endif %}>Ch∆∞a thanh to√°n</option>
                    <option value="overdue" {% if selected_status == 'overdue' %}selected{% endif %}>Qu√° h·∫°n</option>
                </select>
                
                <select name="service" class="filter-select">
                    <option value="">T·∫•t c·∫£ d·ªãch v·ª•</option>
                    <option value="rent" {% if selected_service == 'rent' %}selected{% endif %}>Ti·ªÅn thu√™ ph√≤ng</option>
                    <option value="electricity" {% if selected_service == 'electricity' %}selected{% endif %}>ƒêi·ªán</option>
                    <option value="water" {% if selected_service == 'water' %}selected{% endif %}>N∆∞·ªõc</option>
                    <option value="internet" {% if selected_service == 'internet' %}selected{% endif %}>Internet</option>
                    <option value="maintenance" {% if selected_service == 'maintenance' %}selected{% endif %}>B·∫£o tr√¨</option>
                    <option value="other" {% if selected_service == 'other' %}selected{% endif %}>Kh√°c</option>
                </select>
                
                <select name="building" class="filter-select select-building">
                    <option value="">T·∫•t c·∫£ t√≤a nh√†</option>
                    {% for building in buildings %}
                        <option value="{{ building.id }}" {% if selected_building|stringformat:"s" == building.id|stringformat:"s" %}selected{% endif %}>
                            {{ building.name }}
                        </option>
                    {% endfor %}
                </select>
                
                <input type="date" name="date_from" class="filter-select" value="{{ request.GET.date_from }}" placeholder="T·ª´ ng√†y">
                <span class="filter-arrow">‚Üí</span>
                <input type="date" name="date_to" class="filter-select" value="{{ request.GET.date_to }}" placeholder="ƒê·∫øn ng√†y">
                
                <input type="text" name="search" class="search-input" 
                       value="{{ search_query }}"
                       placeholder="üîç T√¨m m√£ Hƒê, ph√≤ng, c∆∞ d√¢n..." 
                       onkeypress="if(event.key==='Enter') this.form.submit()">
                
                <button type="submit" class="btn-secondary">
                    <i class="fa-solid fa-filter"></i> L·ªçc
                </button>
                
                {% if search_query or selected_status or selected_service or selected_building or request.GET.date_from or request.GET.date_to %}
                <a href="{% url 'get_all_invoices' %}" class="btn-secondary">
                    <i class="fa-solid fa-rotate"></i> Reset
                </a>
                {% endif %}
            </form>
        </div>
        
        <div class="actions">
            <a href="{% url 'create_invoice' %}" class="btn-primary">
                <i class="fa-solid fa-plus"></i> Th√™m h√≥a ƒë∆°n
            </a>
        </div>
    </div>

    <!-- Invoices Table -->
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>M√£ Hƒê</th>
                    <th>Lo·∫°i d·ªãch v·ª•</th>
                    <th>Ph√≤ng</th>
                    <th>C∆∞ d√¢n</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>ƒê∆°n gi√°</th>
                    <th>T·ªïng ti·ªÅn</th>
                    <th>Ng√†y thu ph√≠</th>
                    <th>Ng√†y h·∫øt h·∫°n</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody>
                {% if invoices %}
                    {% for invoice in invoices %}
                    <tr>
                        <td><strong class="id-highlight">{{ invoice.invoice_id }}</strong></td>
                        <td>
                            {% if invoice.service == 'rent' %}
                                <span class="badge badge-primary">Ti·ªÅn thu√™</span>
                            {% elif invoice.service == 'electricity' %}
                                <span class="badge badge-warning">ƒêi·ªán</span>
                            {% elif invoice.service == 'water' %}
                                <span class="badge badge-info">N∆∞·ªõc</span>
                            {% elif invoice.service == 'internet' %}
                                <span class="badge badge-success">Internet</span>
                            {% elif invoice.service == 'maintenance' %}
                                <span class="badge badge-danger">B·∫£o tr√¨</span>
                            {% else %}
                                <span class="badge">Kh√°c</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="building-name">{{ invoice.room.building.name }}</div>
                            <div class="room-number">{{ invoice.room.room_number }}</div>
                        </td>
                        <td>
                            {% if invoice.resident %}
                                {{ invoice.resident.last_name }} {{ invoice.resident.first_name }}
                            {% else %}
                                <span class="text-empty">--</span>
                            {% endif %}
                        </td>
                        <td class="table-cell-center">{{ invoice.count_unit }}</td>
                        <td class="table-cell-right">{{ invoice.unit_price|floatformat:0 }} VNƒê</td>
                        <td class="table-cell-right"><strong>{{ invoice.total_price|floatformat:0 }} VNƒê</strong></td>
                        <td>{{ invoice.start_date|date:"d/m/Y" }}</td>
                        <td>
                            {% if invoice.end_date %}
                                {{ invoice.end_date|date:"d/m/Y" }}
                            {% else %}
                                <span class="text-empty">--</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if invoice.status == 'paid' %}
                                <span class="status-badge status-paid"><i class="fa-solid fa-circle-check"></i> ƒê√£ thanh to√°n</span>
                            {% elif invoice.status == 'unpaid' %}
                                <span class="status-badge status-unpaid"><i class="fa-solid fa-clock"></i> Ch∆∞a thanh to√°n</span>
                            {% elif invoice.status == 'overdue' %}
                                <span class="status-badge status-overdue"><i class="fa-solid fa-exclamation-circle"></i> Qu√° h·∫°n</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="{% url 'get_invoice_details' invoice_id=invoice.invoice_id %}" class="btn-icon" title="Xem chi ti·∫øt">
                                    <i class="fa-solid fa-eye"></i>
                                </a>
                                <a href="{% url 'update_invoice' invoice_id=invoice.invoice_id %}" class="btn-icon" title="Ch·ªânh s·ª≠a">
                                    <i class="fa-solid fa-edit"></i>
                                </a>
                                {% if invoice.status != 'paid' %}
                                <form method="POST" action="{% url 'mark_invoice_paid' invoice_id=invoice.invoice_id %}" class="form-inline-form">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-icon btn-success" title="ƒê√°nh d·∫•u ƒë√£ thanh to√°n" onclick="return confirm('X√°c nh·∫≠n ƒë√°nh d·∫•u ƒë√£ thanh to√°n?');">
                                        <i class="fa-solid fa-check"></i>
                                    </button>
                                </form>
                                {% endif %}
                                <form method="POST" action="{% url 'delete_invoice' invoice_id=invoice.invoice_id %}" class="form-inline-form">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-icon btn-danger" title="X√≥a" onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h√≥a ƒë∆°n n√†y?');">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="11">
                            <div class="empty-state">
                                <i class="fa-solid fa-inbox"></i>
                                <p>
                                    {% if search_query or selected_status or selected_service %}
                                        Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n ph√π h·ª£p
                                    {% else %}
                                        Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o
                                    {% endif %}
                                </p>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/invoices.js' %}"></script>
{% endblock %}
