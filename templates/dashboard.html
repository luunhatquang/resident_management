{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<!-- No extra CSS needed for dashboard -->
{% endblock %}

{% block header_icon %}<i class="fa-solid fa-chart-line"></i>{% endblock %}
{% block header_title %}
Tổng quan {{ building_name }}
<div style="margin-left: 20px;">
    <select onchange="window.location.href='?building='+this.value" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 14px; outline: none;">
        <option value="Toàn bộ tòa nhà" {% if building_name == "Toàn bộ tòa nhà" %}selected{% endif %}>Toàn bộ tòa nhà</option>
        {% for b in buildings %}
            <option value="{{ b.name }}" {% if b.name == active_building.name and building_name != "Toàn bộ tòa nhà" %}selected{% endif %}>{{ b.name }}</option>
        {% endfor %}
    </select>
</div>
{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-title">Tổng số căn hộ</div>
        <div class="stat-value" id="stat-total">{{ room_total }}</div>
        <div style="color: var(--primary-color); font-size: 12px; margin-top: 5px;">
            <i class="fa-solid fa-building"></i> {{ building_name }}
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-title">Đã cho thuê/Bán</div>
        <div class="stat-value" style="color: var(--status-occupied);" id="stat-occupied">{{ room_occupied_count }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-title">Còn trống</div>
        <div class="stat-value" style="color: var(--status-empty);" id="stat-empty">{{ room_empty_count }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-title">Doanh thu tháng này</div>
        <div class="stat-value">{{ revenue|floatformat:0 }} VNĐ</div>
        <div style="color: {% if revenue_growth >= 0 %}#10b981{% else %}#ef4444{% endif %}; font-size: 12px; margin-top: 5px;">
            <i class="fa-solid {% if revenue_growth >= 0 %}fa-arrow-trend-up{% else %}fa-arrow-trend-down{% endif %}"></i> 
            {{ revenue_growth }}% so với tháng trước
        </div>
    </div>
</div>

<!-- Building Map -->
<div class="section-title">
    <span>
        <i class="fa-solid fa-map"></i> Sơ đồ căn hộ trực quan 
        {% if building_name == "Toàn bộ tòa nhà" and active_building %}
            ({{ active_building.name }})
        {% endif %}
    </span>
    
    <div class="building-legend">
        <div class="legend-item">
            <div class="dot" style="background: var(--status-occupied)"></div> Đã ở
        </div>
        <div class="legend-item">
            <div class="dot" style="background: var(--status-empty)"></div> Trống
        </div>
        <div class="legend-item">
            <div class="dot" style="background: var(--status-maintenance)"></div> Bảo trì
        </div>
        <div class="legend-item">
            <div class="warning-icon" style="position:static; animation:none; width:18px; height:18px; font-size:10px">!</div> Sắp hết HĐ
        </div>
    </div>
</div>

<div class="building-container" id="building-map">
    {% for floor in floors %}
    <div class="floor-row">
        <div class="floor-label">Tầng {{ floor.number }}</div>
        <div class="apartments-list">
            {% for room in floor.rooms %}
        <div class="apartment-box status-{{ room.status }}" onclick="openRoomDetail({{ room.id }})">
            <div class="apt-number">{{ room.room_number }}</div>
            <div class="apt-status-text">{{ room.get_status_display }}</div>
            
            {% if room.active_contract and room.active_contract.is_expiring %}
                <div class="warning-icon" title="Sắp hết hạn hợp đồng">!</div>
            {% endif %}
        </div>
            {% endfor %}
        </div>
    </div>
    {% empty %}
    <div style="text-align: center; padding: 40px; color: #64748b;">
        <i class="fa-solid fa-circle-info"></i> Không có dữ liệu căn hộ cho tòa nhà này.
    </div>
    {% endfor %}
</div>

<!-- Modal: Resident Info -->
<div id="resident-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <div class="modal-header">
            <h2 id="modal-apt-number">Căn hộ ...</h2>
        </div>
        
        <div class="info-row">
            <span class="info-label">Trạng thái:</span>
            <span id="modal-apt-status" style="font-weight: bold;">...</span>
        </div>
        <div class="info-row">
            <span class="info-label">Diện tích:</span>
            <span id="modal-apt-area">...</span>
        </div>

        <h3 style="margin-top: 20px; font-size: 16px;">Danh sách cư dân</h3>
        <div class="resident-list" id="modal-residents-list">
            <!-- JS will populate this -->
        </div>

        <div style="margin-top: 20px; text-align: right;">
            <a id="btn-update-profile" href="{% url 'profile' %}" style="padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; display: inline-block;">
                <i class="fa-solid fa-pen-to-square"></i> Cập nhật hồ sơ
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/script.js' %}"></script>
{% endblock %}
