{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<!-- No extra CSS needed for dashboard -->
{% endblock %}

{% block header_icon %}<i class="fa-solid fa-chart-line"></i>{% endblock %}
{% block header_title %}
                Tổng quan {{ building_name }}
            <div style="margin-left: 20px;">
                <select onchange="window.location.href='?building='+this.value" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 14px; outline: none;">
                    <option value="Toàn bộ tòa nhà" {% if building_name == "Toàn bộ tòa nhà" or not active_building %}selected{% endif %}>Toàn bộ tòa nhà</option>
                    {% for b in buildings %}
                        <option value="{{ b.name }}" {% if active_building and b.name == active_building.name %}selected{% endif %}>{{ b.name }}</option>
                    {% endfor %}
                </select>
            </div>
{% endblock %}

{% block content %}
            <!-- Building Filter -->
            <div class="building-filter-section" style="background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 30px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: var(--text-main); min-width: 150px;">
                        <i class="fa-solid fa-filter" style="color: var(--primary-color);"></i>
                        <span>Lọc theo tòa nhà:</span>
                    </div>
                    <select id="building-filter-select" class="building-filter-select">
                        <option value="Toàn bộ tòa nhà" {% if building_name == 'Toàn bộ tòa nhà' or not active_building %}selected{% endif %}>Toàn bộ tòa nhà</option>
                        {% for b in buildings %}
                        <option value="{{ b.name }}" {% if active_building and b.name == active_building.name %}selected{% endif %}>{{ b.name }}</option>
                        {% endfor %}
                    </select>
                    <button class="btn-secondary" onclick="filterBuilding()" style="padding: 10px 16px;">
                        <i class="fa-solid fa-filter"></i> Lọc
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-header">
                        <div class="stat-content">
                    <div class="stat-title">Tổng số căn hộ</div>
                    <div class="stat-value" id="stat-total">{{ room_total }}</div>
                            <div class="stat-subtitle" style="color: var(--primary-color);">
                        <i class="fa-solid fa-building"></i> {{ building_name }}
                            </div>
                        </div>
                        <div class="stat-icon blue">
                            <i class="fa-solid fa-building"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card red">
                    <div class="stat-header">
                        <div class="stat-content">
                    <div class="stat-title">Đã cho thuê/Bán</div>
                            <div class="stat-value" id="stat-occupied">{{ room_occupied_count }}</div>
                        </div>
                        <div class="stat-icon red">
                            <i class="fa-solid fa-key"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card green">
                    <div class="stat-header">
                        <div class="stat-content">
                    <div class="stat-title">Còn trống</div>
                            <div class="stat-value" id="stat-empty">{{ room_empty_count }}</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fa-solid fa-door-open"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card purple">
                    <div class="stat-header">
                        <div class="stat-content">
            <div class="stat-title">Doanh thu tháng này</div>
                            <div class="stat-value">{{ revenue|floatformat:0 }}</div>
                            <div class="stat-subtitle {% if revenue_growth >= 0 %}positive{% else %}negative{% endif %}">
                <i class="fa-solid {% if revenue_growth >= 0 %}fa-arrow-trend-up{% else %}fa-arrow-trend-down{% endif %}"></i> 
                {{ revenue_growth }}% so với tháng trước
                            </div>
                        </div>
                        <div class="stat-icon purple">
                            <i class="fa-solid fa-money-bill-wave"></i>
                        </div>
            </div>
        </div>
            </div>

<!-- Building Map -->
            <div class="section-title">
                <span>
                    <i class="fa-solid fa-map"></i> Sơ đồ căn hộ trực quan 
                    {% if building_name == "Toàn bộ tòa nhà" and active_building %}
                        ({{ active_building.name }})
                    {% endif %}
                </span>
                
                <div class="building-legend">
                    <div class="legend-item">
                        <div class="dot" style="background: var(--status-occupied)"></div> Đã ở
                    </div>
                    <div class="legend-item">
                        <div class="dot" style="background: var(--status-empty)"></div> Trống
                    </div>
                    <div class="legend-item">
                        <div class="dot" style="background: var(--status-maintenance)"></div> Bảo trì
                    </div>
                    <div class="legend-item">
                        <div class="warning-icon" style="position:static; animation:none; width:18px; height:18px; font-size:10px">!</div> Sắp hết HĐ
                    </div>
                </div>
            </div>

            <div class="building-container" id="building-map">
                {% for building_data in buildings_data %}
                    {% if show_all_buildings %}
                    <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0;">
                        <h3 style="font-size: 18px; font-weight: 600; color: var(--primary-color); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fa-solid fa-building"></i> {{ building_data.building.name }}
                        </h3>
                    {% endif %}
                    {% for floor in building_data.floors %}
                <div class="floor-row">
                    <div class="floor-label">Tầng {{ floor.number }}</div>
                    <div class="apartments-list">
                        {% for room in floor.rooms %}
                    <div class="apartment-box status-{{ room.status }}" onclick="openRoomDetail({{ room.id }})">
                        <div class="apt-number">{{ room.room_number }}</div>
                        <div class="apt-status-text">{{ room.get_status_display }}</div>
                        
                        {% if room.active_contract and room.active_contract.is_expiring %}
                            <div class="warning-icon" title="Sắp hết hạn hợp đồng">!</div>
                        {% endif %}
                    </div>
                        {% endfor %}
                    </div>
                </div>
                    {% endfor %}
                    {% if show_all_buildings %}
                    </div>
                    {% endif %}
                {% empty %}
                <div style="text-align: center; padding: 40px; color: #64748b;">
                    <i class="fa-solid fa-circle-info"></i> Không có dữ liệu căn hộ cho tòa nhà này.
                </div>
                {% endfor %}
            </div>

<!-- Modal: Room Info -->
    <div id="resident-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div class="modal-header">
                <h2 id="modal-apt-number">Căn hộ ...</h2>
            </div>
            
            <div class="info-row">
                <span class="info-label">Tòa nhà:</span>
                <span id="modal-building-name" style="font-weight: bold;">...</span>
            </div>
            <div class="info-row">
                <span class="info-label">Tầng:</span>
                <span id="modal-floor-number" style="font-weight: bold;">...</span>
            </div>
            <div class="info-row">
                <span class="info-label">Trạng thái:</span>
                <span id="modal-apt-status" style="font-weight: bold;">...</span>
            </div>
            <div class="info-row">
                <span class="info-label">Diện tích:</span>
                <span id="modal-apt-area">...</span>
            </div>

            <h3 style="margin-top: 20px; font-size: 16px;">Danh sách cư dân</h3>
            <div class="resident-list" id="modal-residents-list">
                <!-- JS will populate this -->
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <a id="btn-view-detail" href="#" class="btn-secondary" style="padding: 8px 16px; text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
                    <i class="fa-solid fa-eye"></i> Xem chi tiết
                </a>
                <a id="btn-edit-room" href="#" class="btn-primary" style="padding: 8px 16px; text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
                    <i class="fa-solid fa-edit"></i> Chỉnh sửa phòng
                </a>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/script.js' %}"></script>
    <script>
        function filterBuilding() {
            const buildingName = document.getElementById('building-filter-select').value;
            window.location.href = '?building=' + encodeURIComponent(buildingName);
        }
    </script>
{% endblock %}
